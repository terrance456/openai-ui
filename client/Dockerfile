FROM node:16-alpine

ARG NEXT_PUBLIC_CLIENT_FIREBASE_API_KEY
ARG NEXT_PUBLIC_CLIENT_FIREBASE_AUTH_DOMAIN
ARG NEXT_PUBLIC_CLIENT_FIREBASE_PROJECT_ID
ARG NEXT_PUBLIC_CLIENT_FIREBASE_STORAGE_BUCKET
ARG NEXT_PUBLIC_CLIENT_FIREBASE_MESSAGING_SENDER_ID
ARG NEXT_PUBLIC_CLIENT_FIREBASE_APP_ID
ARG NEXT_PUBLIC_CLIENT_ENDPOINT_URL
ARG NEXT_PUBLIC_CLIENT_IMAGE_HOST_URL

WORKDIR /usr/app

COPY ./client/. .

RUN touch .env.production \
    echo "NEXT_PUBLIC_CLIENT_FIREBASE_API_KEY=${NEXT_PUBLIC_CLIENT_FIREBASE_API_KEY}" >> .env.production \
    echo "NEXT_PUBLIC_CLIENT_FIREBASE_AUTH_DOMAIN=${NEXT_PUBLIC_CLIENT_FIREBASE_AUTH_DOMAIN}" >> .env.production \
    echo "NEXT_PUBLIC_CLIENT_FIREBASE_PROJECT_ID=${NEXT_PUBLIC_CLIENT_FIREBASE_PROJECT_ID}" >> .env.production \ 
    echo "NEXT_PUBLIC_CLIENT_FIREBASE_STORAGE_BUCKET=${NEXT_PUBLIC_CLIENT_FIREBASE_STORAGE_BUCKET}" >> .env.production \
    echo "NEXT_PUBLIC_CLIENT_FIREBASE_MESSAGING_SENDER_ID=${NEXT_PUBLIC_CLIENT_FIREBASE_MESSAGING_SENDER_ID}" >> .env.production \
    echo "NEXT_PUBLIC_CLIENT_FIREBASE_APP_ID=${NEXT_PUBLIC_CLIENT_FIREBASE_APP_ID}" >> .env.production \
    echo "NEXT_PUBLIC_CLIENT_ENDPOINT_URL=${NEXT_PUBLIC_CLIENT_ENDPOINT_URL}" >> .env.production \
    echo "NEXT_PUBLIC_CLIENT_IMAGE_HOST_URL=${NEXT_PUBLIC_CLIENT_IMAGE_HOST_URL}" >> .env.production \
    cat .env.production

RUN npm ci --production

RUN npm run build

CMD ["npm", "start"]